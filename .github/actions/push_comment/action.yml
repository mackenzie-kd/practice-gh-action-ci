name: Push Comment to PR
inputs:
  github-token:
    required: true
  pr-url:
    required: true
  comment-text:
    required: true
  report-url:
    required: false
runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        COMMIT_HASH=$(git show --format='%h' --no-patch)

        # ãƒ¬ãƒãƒ¼ãƒˆURLãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ãƒƒã‚¿ãƒ¼ã‚’ç”Ÿæˆ
        # NOTE: é€”ä¸­ã§å¤±æ•—ã™ã‚‹ã¨URLãƒ‘ã‚¹ã ã‘ã«ãªã‚‹ã®ã§ã€httpã‹ã‚‰å§‹ã¾ã‚‹ã‹ã§åˆ¤å®šã™ã‚‹
        if [[ ${REPORT_URL} =~ ^http ]]; then
          COMMENT_FOOTER="
        ### Test Report ğŸ“ˆ
        The test report for this PR can be found at this URL.

        ${REPORT_URL}"
        fi

        # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
        cat << EOF > comments
        ## CI Result Status
        ### ${COMMENT_TEXT}
        - commit: ${COMMIT_HASH}
        - time: $(date +"%Y/%-m/%-d(%a) %-H:%-M:%-S")
        ${COMMENT_FOOTER}
        EOF

        # éå»ã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’å–å¾—
        USER=$(git config user.name | sed "s/\[.*\]//")  # åå‰ã«[bot]ãŒã‚ã‚‹å ´åˆã¯é™¤å»
        COMMENT_COUNT=$(gh pr view --json "comments" --jq ".comments.[] | select (.author.login == \"${USER}\") | .url" | wc -l)

        # ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡
        # https://cli.github.com/manual/gh_pr_comment
        if [ "${COMMENT_COUNT}" -eq 0 ]; then
          gh pr comment "${PR_URL}" -F ./comments
        elif [ "${COMMENT_COUNT}" -eq 1 ]; then
          # "--edit-last"ã§æœ€å¾Œã®ã‚³ãƒŸãƒƒãƒˆã‚’ä¸Šæ›¸ã
          gh pr comment "${PR_URL}" -F ./comments --edit-last
        else
          # è¤‡æ•°ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          echo "cannot edit because there are multiple comments. count = ${COMMENT_COUNT}"
          exit 1
        fi

      env:
        TZ: Asia/Tokyo
        GITHUB_TOKEN: ${{ inputs.github-token }}
        PR_URL: ${{ inputs.pr-url }}
        COMMENT_TEXT: ${{ inputs.comment-text }}
        REPORT_URL: ${{ inputs.report-url }}
