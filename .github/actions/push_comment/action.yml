name: Push Comment to PR
# inputs:
#   who-to-greet:  # id of input
#     description: 'Who to greet'
#     required: true
#     default: 'World'
# outputs:
#   random-number:
#     description: "Random number"
#     value: ${{ steps.random-number-generator.outputs.random-id }}
runs:
  using: "composite"
  steps:
    - run: |
        COMMIT_HASH=$(git show --format='%h' --no-patch)

        # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
        cat << EOF > comments
        ## Test Report
        ğŸ˜ŠğŸ‘ PASS!!! ğŸ’¯ğŸ‰
        (commit: ${COMMIT_HASH})

        The test report for this PR can be found at this URL.

        ${PAGE_URL}${REPORT_OUTPUT_PATH}/report.html
        EOF

        # éå»ã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’å–å¾—
        USER=$(git config user.name | sed "s/\[.*\]//")  # åå‰ã«[bot]ãŒã‚ã‚‹å ´åˆã¯é™¤å»
        COMMENT_COUNT=$(gh pr view --json "comments" --jq ".comments.[] | select (.author.login == \"${USER}\") | .url" | wc -l)

        # ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡
        # https://cli.github.com/manual/gh_pr_comment
        if [ "${COMMENT_COUNT}" -eq 0 ]; then
          gh pr comment "${PR_URL}" -F ./comments
        elif [ "${COMMENT_COUNT}" -eq 1 ]; then
          # "--edit-last"ã§æœ€å¾Œã®ã‚³ãƒŸãƒƒãƒˆã‚’ä¸Šæ›¸ã
          gh pr comment "${PR_URL}" -F ./comments --edit-last
        else
          # è¤‡æ•°ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          echo "cannot edit because there are multiple comments. count = ${COMMENT_COUNT}"
          exit 1
        fi

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_URL: ${{ github.event.pull_request.html_url }}
        PAGE_URL: ${{ steps.deployment.outputs.page_url }}
        REPORT_OUTPUT_PATH: ${{ steps.generate_report_url.outputs.report_output_path }}
