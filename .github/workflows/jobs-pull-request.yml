name: Run Any Actions on PR
'on': pull_request

env:
  GIT_HUB_APP_NAME: joint-purchase-github-app[bot]
  GIT_HUB_APP_EMAIL: 123704127+joint-purchase-github-app[bot]@users.noreply.github.com

jobs:
  check:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    steps:
      - name: View all pull requests
        run: |
            gh pr list \
              --repo $REPO \
              --state all \
              --json additions,assignees,author,baseRefName,body,changedFiles,closed,closedAt,comments,commits,createdAt,deletions,files,headRefName,headRefOid,headRepository,headRepositoryOwner,id,isCrossRepository,isDraft,labels,latestReviews,maintainerCanModify,mergeable,mergeCommit,mergedAt,mergedBy,mergeStateStatus,milestone,number,potentialMergeCommit,projectCards,reactionGroups,reviewDecision,reviewRequests,reviews,state,statusCheckRollup,title,updatedAt,url
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}

      # å…ˆã«ä½œæˆã•ã‚ŒãŸPRãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ä¸Šæ›¸ãã—ã¦ã—ã¾ã†ç‚ºã€ãƒ‡ãƒ—ãƒ­ã‚¤ã›ãšã‚¸ãƒ§ãƒ–ã‚’åœæ­¢ã™ã‚‹
      - name: Get count of other open pull requests
        id: get_other_open_pr_count
        run: |
          OTHER_OPEN_PR_COUNT=$(\
            gh pr list \
              --repo $REPO \
              --state open \
              --json number | jq ".[].number | select(. < $PR_NUMBER)" \
              | wc -l
          )
          echo "other_open_pr_count=$OTHER_OPEN_PR_COUNT" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
      - name: Check count of other open pull requests
        if: steps.get_other_open_pr_count.outputs.other_open_pr_count > 0
        run: |
          echo "Cancel deployment because other pull requests exist. (OTHER_OPEN_PR_COUNT = $OTHER_OPEN_PR_COUNT)"
          exit 1
        env:
          OTHER_OPEN_PR_COUNT: ${{ steps.get_other_open_pr_count.outputs.other_open_pr_count }}

  build:
    needs: check
    runs-on: ubuntu-latest
    # ãƒ†ã‚¹ãƒˆãªã®ã§å…¨ã¦ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä¸ãˆã‚‹
    permissions:
      actions: write
      checks: write
      contents: write
      deployments: write
      issues: write
      packages: write
      pull-requests: write
      repository-projects: write
      security-events: write
      statuses: write
    steps:
      - name: Configure of github app
        run: |
          git config --global user.name ${{ env.GIT_HUB_APP_NAME }}
          git config --global user.email ${{ env.GIT_HUB_APP_EMAIL }}
          git config --global pull.rebase false

      # Checkoutï¼ˆç›´å‰ã‚ˆã‚Šå‰ã®ã‚³ãƒŸãƒƒãƒˆã‚‚å¯¾è±¡ï¼‰
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # ãƒãƒ¼ã‚¸å…ˆã®ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚“ã§push
      - name: Get latest base branch name
        id: get_latest_base_branch_name
        run: |
          LATEST_BASE_BRANCH_NAME=$(\
            gh pr list \
              --repo $REPO \
              --state open \
              --json number,baseRefName | jq -r ".[] | select(.number == $PR_NUMBER) | .baseRefName"
          )
          echo "latest_base_branch_name=$LATEST_BASE_BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
      - name: Merge from head branch and Push to base branch
        run: |
          git pull origin $PR_TO_BRANCH_NAME
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TO_BRANCH_NAME: ${{ steps.get_latest_base_branch_name.outputs.latest_base_branch_name }}

      # Build
      - name: Setup
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn
          cache-dependency-path: ./yarn.lock
      - name: Build
        run: yarn --frozen-lockfile && yarn run build

  test:
    needs: build
    runs-on: ubuntu-latest
    # ãƒ†ã‚¹ãƒˆãªã®ã§å…¨ã¦ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä¸ãˆã‚‹
    permissions:
      actions: write
      checks: write
      contents: write
      deployments: write
      issues: write
      packages: write
      pull-requests: write
      repository-projects: write
      security-events: write
      statuses: write

      # Github Pagesã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™
      # contents: read
      pages: write
      id-token: write

    steps:
      - name: Configure of github app
        run: |
          git config --global user.name ${{ env.GIT_HUB_APP_NAME }}
          git config --global user.email ${{ env.GIT_HUB_APP_EMAIL }}

      # Checkout
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # Generate Report Info
      - name: Generate Report Info
        id: generate_report_info
        run: |
          PR_NUM=$(jq --raw-output .pull_request.number ${GITHUB_EVENT_PATH})
          PR_TITLE=$(jq --raw-output .pull_request.title ${GITHUB_EVENT_PATH})
          COMMIT_SHORT_HASH=$(git show --format='%h' --no-patch)

          # ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
          REPORT_OUTPUT_PATH="ci/pr${PR_NUM}/${COMMIT_SHORT_HASH}"
          echo "report_output_path=$REPORT_OUTPUT_PATH" >> $GITHUB_OUTPUT

          # ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
          REPORT_TITLE="Report #${PR_NUM} ${PR_TITLE}"
          echo "report_title=$REPORT_TITLE" >> $GITHUB_OUTPUT

          # ãƒãƒƒã‚·ãƒ¥ã‚³ãƒŸãƒƒãƒˆã®URLã‚’ç”Ÿæˆ
          COMMIT_HASH_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/$(git rev-parse HEAD)"
          echo "commit_hash_url=$COMMIT_HASH_URL" >> $GITHUB_OUTPUT

          # Artifactsã®åå‰ã‚’ç”Ÿæˆ
          # NOTE: åŒã˜ãƒãƒƒã‚·ãƒ¥ã§Actionsã‚’2å›å®Ÿè¡Œã—ãŸæ™‚ã¯å¾Œã®Artifactsã—ã‹æ®‹ã‚‰ãªã„ã®ã§ã€ãƒãƒƒã‚·ãƒ¥ã ã‘åå‰ã«ä»˜ä¸ã™ã‚‹
          PAGE_ARTIFACT_NAME="github-pages-${COMMIT_SHORT_HASH}"
          echo "page_artifact_name=$PAGE_ARTIFACT_NAME" >> $GITHUB_OUTPUT

      # Push Comment (Test Running)
      - name: Push Test Finish Comment
        uses: ./.github/actions/push_comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-url: ${{ github.event.pull_request.html_url }}
          comment-text: "Test running... ğŸƒğŸš²ğŸš“"

      # Test
      - name: Setup
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn
          cache-dependency-path: ./yarn.lock
      - name: Test
        run: yarn --frozen-lockfile && yarn run test
        env:
          JEST_HTML_REPORTERS_PUBLIC_PATH: gh_page/${{ steps.generate_report_info.outputs.report_output_path }}
          JEST_HTML_REPORTERS_PAGE_TITLE: ${{ steps.generate_report_info.outputs.report_title }}
          JEST_HTML_REPORTERS_URL_FOR_TEST_FILES: ${{ steps.generate_report_info.outputs.commit_hash_url }}

      # Upload Report
      - name: Upload artifact
        if: ${{ always() }} # ãƒ†ã‚¹ãƒˆå¤±æ•—ã§ã‚‚å®Ÿè¡Œ
        uses: actions/upload-pages-artifact@v3
        with:
          name: ${{ steps.generate_report_info.outputs.page_artifact_name }}
          path: ./gh_page
      - name: Deploy to GitHub Pages
        if: ${{ always() }} # ãƒ†ã‚¹ãƒˆå¤±æ•—ã§ã‚‚å®Ÿè¡Œ
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: ${{ steps.generate_report_info.outputs.page_artifact_name }}

      # Push Comment (Test Passed)
      - name: Push Test Passed Comment
        if: ${{ success() }} # ãƒ†ã‚¹ãƒˆæˆåŠŸã§å®Ÿè¡Œ
        uses: ./.github/actions/push_comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-url: ${{ github.event.pull_request.html_url }}
          comment-text: "Test Passed !! ğŸ¤ŸğŸ˜ŠğŸ’¯"
          report-url: ${{ steps.deployment.outputs.page_url }}${{ steps.generate_report_info.outputs.report_output_path }}/report.html

      # Push Comment (Test Failed)
      - name: Push Test Failed Comment
        if: ${{ failure() }} # ãƒ†ã‚¹ãƒˆå¤±æ•—ã§å®Ÿè¡Œ
        uses: ./.github/actions/push_comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-url: ${{ github.event.pull_request.html_url }}
          comment-text: "Test failed !! ğŸ–•ğŸ‘ºğŸ’¥"
          report-url: ${{ steps.deployment.outputs.page_url }}${{ steps.generate_report_info.outputs.report_output_path }}/report.html
